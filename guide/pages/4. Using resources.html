<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>4. Using resources</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    Now that you know how to declare resources, you need to use them in your page.<p class="paragraph"/>There are several tags for this purpose, but the primary means is to use the &#60;r:require&#62; tag to indicate which modules you need, and the &#60;r:layoutResources/&#62; tag to perform the rendering of the resources.<p class="paragraph"/>The &#60;r:require&#62; tag causes the framework to look up all the resources required to satisfy your module dependencies. However nothing is rendered at that point.<p class="paragraph"/>The &#60;r:layoutResources/&#62; tag is called to render the resources themselves (and internally it calls into r:external for each resource). This tag has special behaviour, in that the first time you call it, it automatically renders only resources with disposition "head". The second time you call it, it automatically renders only resources with disposition "defer".<p class="paragraph"/><h2>Linking to CSS, JavaScript and Favicons</h2><p class="paragraph"/>So you need to add two calls to &#60;r:layoutResource/&#62; to your GSP page or sitemesh layout. Normally you will place it in your sitemesh layout:<p class="paragraph"/>Your grails-app/views/layouts/main.gsp:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;g:layoutTitle/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;g:layoutBody/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>You can of course include any common modules you require in your sitemesh layout using &#60;r:require&#62; but they must appear before the first &#60;r:layoutResources/&#62;.<p class="paragraph"/>In your GSP pages you invoke &#60;r:require&#62; as many times as required, even inside GSP templates that you include with g:render, and you can include resources conditionally - something that can be really hard to do without resource dependency management.<p class="paragraph"/>Example GSP page:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;meta name=<span class="xml&#45;quote">"layout"</span> content=<span class="xml&#45;quote">"main"</span>/&#62;</span>
      <span class="xml&#45;tag">&#60;r:require module=<span class="xml&#45;quote">"jquery&#45;ui, blueprint"</span>/&#62;</span>
      <span class="xml&#45;tag">&#60;g:if test=<span class="xml&#45;quote">"$&#123;customerBranding&#125;"</span>&#62;</span>
          <span class="xml&#45;tag">&#60;r:require module=<span class="xml&#45;quote">"theme_$&#123;customer.theme&#125;"</span>/&#62;</span>
      <span class="xml&#45;tag">&#60;/g:if&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;div&#62;</span>
           Hello World
      <span class="xml&#45;tag">&#60;/div&#62;</span>  
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/><h2>Linking to images</h2><p class="paragraph"/>When you need to render an &#60;img&#62; tag that you wish to be subject to the Resources processing chain (e.g. to make it eternally cacheable) you should use the &#60;r:img&#62; tag:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;r:img uri=<span class="xml&#45;quote">"images/logo.png"</span> width=<span class="xml&#45;quote">"100"</span> height=<span class="xml&#45;quote">"50"</span>/&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;r:img dir=<span class="xml&#45;quote">"images"</span> file=<span class="xml&#45;quote">"logo.png"</span> width=<span class="xml&#45;quote">"100"</span> height=<span class="xml&#45;quote">"50"</span>/&#62;</span></pre></div><p class="paragraph"/>Usually this will produce a link to an undeclared resource. However you can declare images in modules and specify extra attributes in "attrs" to supply e.g. the width and height:<p class="paragraph"/><div class="code"><pre>modules = &#123;
    images &#123;
        resource url:'images/logo.png', attrs:&#91;width:100, height:50, alt:'Our logo'&#93;, disposition:'inline'
        resource url:'images/icon/add.png', attrs:&#91;width:32, height:32, alt:'Add'&#93;, disposition:'inline'
    &#125;
&#125;</pre></div><p class="paragraph"/>The disposition "inline" is optional - as long as you don't have any other modules that "dependOn" the images module and link using r:resource or r:img, you won't need this.<p class="paragraph"/><h2>Linking to resources explicitly, bypassing modules</h2><p class="paragraph"/>Sometimes you may need to link to a specific resource, or produce a URL pointing to the specific resource without rendering links to all the modules it depends on - or outside of a context where you can call &#60;r:layoutResources/&#62;. You may even wish to link to an undeclared resource, but still want it to be subject to processing on the fly.<p class="paragraph"/>To link to CSS or other resources that are not declared in a module you use &#60;r:external&#62;:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;r:external uri=<span class="xml&#45;quote">"js/custom.js"</span>/&#62;</span>
<span class="xml&#45;tag">&#60;script type=<span class="xml&#45;quote">"text/javascript"</span>&#62;</span>
    var urlOfCSSToLoadInJSCode = '$&#123;r.external(uri:<span class="xml&#45;quote">"css/custom.css"</span>).encodeAsJavaScript()';
<span class="xml&#45;tag">&#60;/script&#62;</span>
<span class="xml&#45;tag">&#60;r:external uri=<span class="xml&#45;quote">"icons/favicon.ico"</span>/&#62;</span></pre></div><p class="paragraph"/>This would output the &#60;script&#62; and &#60;link&#62; tags required to include those resources, without rendering their dependencies first - whether the resource is declared in a module or not. The example shows how you might pass the URL of a resource to some JavaScript code for use later at runtime.<p class="paragraph"/><h2>Including pieces of JavaScript code generated at runtime</h2><p class="paragraph"/>Often in an application, especially those using custom Grails tags and rich UIs, you will need to render fragments of JavaScript code while the page is being rendered. It is not always possible to know what JS code there will be in the page until the render process is finished.<p class="paragraph"/>The &#60;r:script&#62; tag allows you to specify sections of JavaScript text during page rendering, but if using Sitemesh layouts, you will be able to have these fragments appear either in &#60;head&#62; or deferred to the end of the page, just like other JavaScript resources.<p class="paragraph"/>This integrates with the disposition mechanism, allowing you to throw your JavaScript into a specific location:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;r:script/&#62;</span>
    window.alert('This is the end of the page!');
<span class="xml&#45;tag">&#60;/r:script&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;r:script disposition='head'/&#62;</span>
    window.alert('This is the head of the page!');
<span class="xml&#45;tag">&#60;/r:script&#62;</span></pre></div><p class="paragraph"/>What happens is the &#60;r:script&#62; tag stashes your fragment in the request attributes until &#60;r:layoutResources/&#62; is called - when it is pulled out of the attributes and rendered according to the current disposition being rendered.<p class="paragraph"/>This is ideal for other custom Grails GSP taglibs to use to write out their JS code used to e.g. set up UI elements:<p class="paragraph"/><div class="code"><pre>class MyCustomTagLib &#123;
    def datePicker = &#123;
        out &#60;&#60; r.script(disposition:'head') &#123;
            out &#60;&#60; '$("&#35;'+attrs.id.encodeAsJavaScript()+').datePicker();'
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>The order of code is preserved, and all such fragments are rendered <strong class="bold">after</strong> all the modules required by the page (in that disposition) have been included.
    </body>
</html>
